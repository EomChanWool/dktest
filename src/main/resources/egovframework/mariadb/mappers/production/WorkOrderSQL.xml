<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="apc.sl.production.workOrder.service.impl.WorkOrderMapper">
	<select id="selectWorkOrderListToCnt" resultType="int">
		SELECT 
			COUNT(*) 
		FROM sm_work_order a
		JOIN sm_item b
		ON a.item_cd = b.item_cd
		WHERE 1=1
		<if test="searchKeyword != ''">
			AND wo_name = #{searchKeyword}
		</if>
		<if test="searchStDate != ''">
			AND wo_itn_dte >= #{searchStDate}
		</if>
		<if test="searchEdDate !=''">
			AND wo_itn_dte <![CDATA[<=]]> #{searchEdDate}
		</if>
	</select>
	
	<select id="selectWorkOrderList" resultType="egovMap">
		SELECT
			a.wo_idx,
			a.wo_name,
			a.item_cd,
			a.wo_pdt_cnt,
			a.wo_itn_dte,
			a.wo_state,
			b.item_name
		FROM sm_work_order a
		JOIN sm_item b
		ON a.item_cd = b.item_cd
		WHERE 1=1
		<if test="searchKeyword != ''">
			AND wo_name LIKE CONCAT('%',#{searchKeyword},'%')
		</if>
		<if test="searchStDate != ''">
			AND wo_itn_dte >= #{searchStDate}
		</if>
		<if test="searchEdDate !=''">
			AND wo_itn_dte <![CDATA[<=]]> #{searchEdDate}
		</if>
		ORDER BY wo_idx DESC
		LIMIT #{recordCountPerPage} OFFSET #{firstIndex}
	</select>
	
	<select id="selectMaterialList" resultType="egovMap">
		SELECT item_cd, item_name FROM sm_item WHERE item_type = '자재'
	</select>
	
	<select id="selectMaterialStd" resultType="egovMap">
		SELECT item_std, item_name FROM sm_item WHERE item_cd = #{itemCd}
	</select>
	
	<select id="selectProductList" resultType="egovMap">
		SELECT item_cd, item_name FROM sm_item WHERE item_type = '제품'
	</select>
	
	<select id="selectOrderIdx" resultType="int">
		SELECT COUNT(*) FROM sm_orders WHERE or_idx = #{orIdx}
	</select>
	
	<select id="selectItemCode" resultType="int">
		SELECT COUNT(*) FROM sm_item WHERE item_cd = #{itemCd}
	</select>
	
	<select id="checkItemStock" resultType="int">
		SELECT COUNT(*) FROM sm_item WHERE item_cd = #{itemCd} AND item_cnt >= #{cnt}
	</select>
	
	<insert id="registWorkOrder">
		INSERT INTO sm_work_order
			(
			wo_idx,
			wo_name,
			item_cd,
			wo_pdt_cnt,
			wo_itn_dte,
			<if test="woCmtDte != ''">wo_cmt_dte,</if>
			<if test="woDlvDte != ''">wo_dlv_dte,</if>
			<if test="woNote != ''">wo_note,</if>
			wo_reg_dte,
			wo_reg_mem
			)
		VALUES
			(
			(SELECT CONCAT(CONCAT('WO',SUBSTRING(DATE_FORMAT(#{woItnDte},'%Y%m'),3,6)),'',
				(SELECT LPAD((SELECT IFNULL(MAX(SUBSTRING(a.wo_idx,7,9)),0)+1 
					FROM sm_work_order a 
					WHERE a.wo_idx 
					LIKE CONCAT(CONCAT('WO',SUBSTRING(DATE_FORMAT(#{woItnDte},'%Y%m'),3,6)), '%')),3,0))) AS WO),
			#{woName},
			#{itemCd},
			#{woPdtCnt},
			#{woItnDte},
			<if test="woCmtDte != ''">#{woCmtDte},</if>
			<if test="woDlvDte != ''">#{woDlvDte},</if>
			<if test="woNote != ''">#{woNote},</if>
			NOW(),
			#{userId}
			)
	</insert>
	
	<select id="selectProcessList" resultType="egovMap">
		SELECT pr_list_idx, pr_list_seq, pr_list_nm FROM sm_process_list
	</select>
	
	<insert id="registProcess">
		INSERT INTO sm_process
			(
			pr_idx,
			wo_idx,
			pr_cur_seq,
			pr_list_cur_idx,
			pr_list_cur_nm,
			pr_tot_cnt,
			pr_fin_cnt,
			pr_list_idx1, pr_list_nm1, pr_st_time1, pr_ed_time1, pr_cnt1, pr_faulty1,
			pr_list_idx2, pr_list_nm2, pr_st_time2, pr_ed_time2, pr_cnt2, pr_faulty2,
			pr_list_idx3, pr_list_nm3, pr_st_time3, pr_ed_time3, pr_cnt3, pr_faulty3,
			pr_list_idx4, pr_list_nm4, pr_st_time4, pr_ed_time4, pr_cnt4, pr_faulty4,
			pr_list_idx5, pr_list_nm5, pr_st_time5, pr_ed_time5, pr_cnt5, pr_faulty5,
			pr_list_idx6, pr_list_nm6, pr_st_time6, pr_ed_time6, pr_cnt6, pr_faulty6,
			pr_list_idx7, pr_list_nm7, pr_st_time7, pr_ed_time7, pr_cnt7, pr_faulty7,
			pr_list_idx8, pr_list_nm8, pr_st_time8, pr_ed_time8, pr_cnt8, pr_faulty8,
			pr_list_idx9, pr_list_nm9, pr_st_time9, pr_ed_time9, pr_cnt9, pr_faulty9,
			pr_list_idx10, pr_list_nm10, pr_st_time10, pr_ed_time10, pr_cnt10, pr_faulty10,
			pr_reg_mem,
			pr_reg_dte
			)
		VALUES
			(
			(SELECT CONCAT('PR', LPAD((SELECT (SELECT REGEXP_REPLACE((SELECT IFNULL(MAX(a.pr_idx),0) FROM sm_process a),'[a-z]','')))+1,10,0))),
			(SELECT CONCAT(CONCAT('WO',SUBSTRING(DATE_FORMAT(#{woItnDte},'%Y%m'),3,6)),'',
				(SELECT LPAD((SELECT IFNULL(MAX(SUBSTRING(a.wo_idx,7,9)),0) 
					FROM sm_work_order a 
					WHERE a.wo_idx 
					LIKE CONCAT(CONCAT('WO',SUBSTRING(DATE_FORMAT(#{woItnDte},'%Y%m'),3,6)), '%')),3,0))) AS WO),
			'1',
			#{idx1},
			#{nm1},
			#{totCnt},
			'0',
			<if test="idx1 != ''">#{idx1}, #{nm1}, null, null, null, null,</if>
			<if test="idx2 != ''">#{idx2}, #{nm2}, null, null, null, null,</if>
			<if test="idx3 != ''">#{idx3}, #{nm3}, null, null, null, null,</if>
			<if test="idx4 != ''">#{idx4}, #{nm4}, null, null, null, null,</if>
			<if test="idx5 != ''">#{idx5}, #{nm5}, null, null, null, null,</if>
			<if test="idx6 != ''">#{idx6}, #{nm6}, null, null, null, null,</if>
			<if test="idx7 != ''">#{idx7}, #{nm7}, null, null, null, null,</if>
			<if test="idx8 != ''">#{idx8}, #{nm8}, null, null, null, null,</if>
			<if test="idx9 != ''">#{idx9}, #{nm9}, null, null, null, null,</if>
			<if test="idx10 != ''">#{idx10}, #{nm10}, null, null, null, null,</if>
			#{userId},
			NOW()
			)
	</insert>
	
	<update id="updateOrder">
		UPDATE sm_orders SET
			or_state = #{state}
		WHERE or_idx = #{orIdx}
	</update>
	
	<select id="selectWorkOrderInfo" resultType="egovMap">
		SELECT
			a.wo_idx,
			a.wo_name,
			a.item_cd,
			a.wo_pdt_cnt,
			a.wo_itn_dte,
			a.wo_cmt_dte,
			a.wo_dlv_dte,
			a.wo_note,
			e.pr_list_cur_nm,
			DATE_FORMAT(a.wo_reg_dte, '%Y-%m-%d %H:%i:%s') AS wo_reg_dte
		FROM sm_work_order a
		JOIN sm_process e
		ON a.wo_idx = e.wo_idx
		WHERE a.wo_idx = #{woIdx}
	</select>
	
	<update id="modifyWorkOrder">
		UPDATE sm_work_order SET
			wo_name = #{woName},
			item_cd = #{itemCd},
			wo_pdt_cnt = #{woPdtCnt},
			wo_itn_dte = #{woItnDte},
			<if test="woCmtDte != ''">wo_cmt_dte = #{woCmtDte},</if>
			<if test="woCmtDte == ''">wo_cmt_dte = null,</if>
			<if test="woDlvDte != ''">wo_dlv_dte = #{woDlvDte},</if>
			<if test="woDlvDte == ''">wo_dlv_dte = null,</if>
			<if test="woNote != ''">wo_note = #{woNote},</if>
			<if test="woNote == ''">wo_note = null,</if>
			wo_edt_dte = NOW(),
			wo_edt_mem = #{userId}
		WHERE wo_idx = #{woIdx}
	</update>
	
	<delete id="deleteWorkOrder">
		DELETE FROM sm_work_order WHERE wo_idx = #{woIdx}
	</delete>
	
	<insert id="registInMaterial">
		INSERT INTO sm_in_material
			(
			item_cd1, item_name1, cnt1,
			item_cd2, item_name2, cnt2,
			item_cd3, item_name3, cnt3,
			item_cd4, item_name4, cnt4,
			item_cd5, item_name5, cnt5,
			item_cd6, item_name6, cnt6,
			item_cd7, item_name7, cnt7,
			item_cd8, item_name8, cnt8,
			item_cd9, item_name9, cnt9,
			item_cd10, item_name10, cnt10,
			item_cd11, item_name11, cnt11,
			item_cd12, item_name12, cnt12,
			item_cd13, item_name13, cnt13,
			item_cd14, item_name14, cnt14,
			item_cd15, item_name15, cnt15,
			wo_idx
			)
		VALUES
			(
			#{itemCd1}, #{itemName1}, #{cnt1},
			<if test="itemCd2 != ''">#{itemCd2}, #{itemName2}, #{cnt2},</if>
			<if test="itemCd3 != ''">#{itemCd3}, #{itemName3}, #{cnt3},</if>
			<if test="itemCd4 != ''">#{itemCd4}, #{itemName4}, #{cnt4},</if>
			<if test="itemCd5 != ''">#{itemCd5}, #{itemName5}, #{cnt5},</if>
			<if test="itemCd6 != ''">#{itemCd6}, #{itemName6}, #{cnt6},</if>
			<if test="itemCd7 != ''">#{itemCd7}, #{itemName7}, #{cnt7},</if>
			<if test="itemCd8 != ''">#{itemCd8}, #{itemName8}, #{cnt8},</if>
			<if test="itemCd9 != ''">#{itemCd9}, #{itemName9}, #{cnt9},</if>
			<if test="itemCd10 != ''">#{itemCd10}, #{itemName10}, #{cnt10},</if>
			<if test="itemCd11 != ''">#{itemCd11}, #{itemName11}, #{cnt11},</if>
			<if test="itemCd12 != ''">#{itemCd12}, #{itemName12}, #{cnt12},</if>
			<if test="itemCd13 != ''">#{itemCd13}, #{itemName13}, #{cnt13},</if>
			<if test="itemCd14 != ''">#{itemCd14}, #{itemName14}, #{cnt14},</if>
			<if test="itemCd15 != ''">#{itemCd15}, #{itemName15}, #{cnt15},</if>
			(SELECT CONCAT(CONCAT('WO',SUBSTRING(DATE_FORMAT(#{woItnDte},'%Y%m'),3,6)),'',
				(SELECT LPAD((SELECT IFNULL(MAX(SUBSTRING(a.wo_idx,7,9)),0)
					FROM sm_work_order a 
					WHERE a.wo_idx 
					LIKE CONCAT(CONCAT('WO',SUBSTRING(DATE_FORMAT(#{woItnDte},'%Y%m'),3,6)), '%')),3,0))) AS WO)
			)
	</insert>
	
	<select id="selectInMaterialList" resultType="egovMap">
		SELECT
			item_cd1, item_name1, cnt1,
			item_cd2, item_name2, cnt2,
			item_cd3, item_name3, cnt3,
			item_cd4, item_name4, cnt4,
			item_cd5, item_name5, cnt5,
			item_cd6, item_name6, cnt6,
			item_cd7, item_name7, cnt7,
			item_cd8, item_name8, cnt8,
			item_cd9, item_name9, cnt9,
			item_cd10, item_name10, cnt10,
			item_cd11, item_name11, cnt11,
			item_cd12, item_name12, cnt12,
			item_cd13, item_name13, cnt13,
			item_cd14, item_name14, cnt14,
			item_cd15, item_name15, cnt15
		FROM sm_in_material
		WHERE wo_idx = #{woIdx}
	</select>
	
	<select id="selectItemStd" resultType="String">
		SELECT item_std FROM sm_item WHERE item_cd = #{itemCd}
	</select>
	
	<update id="modifyInMaterial">
		UPDATE sm_in_material SET
			<if test="itemCd2 != ''">item_cd2 = #{itemCd2}, item_name2 = #{itemName2}, cnt2 = #{cnt2},</if>
			<if test="itemCd3 != ''">item_cd3 = #{itemCd3}, item_name3 = #{itemName3}, cnt3 = #{cnt3},</if>
			<if test="itemCd4 != ''">item_cd4 = #{itemCd4}, item_name4 = #{itemName4}, cnt4 = #{cnt4},</if>
			<if test="itemCd5 != ''">item_cd5 = #{itemCd5}, item_name5 = #{itemName5}, cnt5 = #{cnt5},</if>
			<if test="itemCd6 != ''">item_cd6 = #{itemCd6}, item_name6 = #{itemName6}, cnt6 = #{cnt6},</if>
			<if test="itemCd7 != ''">item_cd7 = #{itemCd7}, item_name7 = #{itemName7}, cnt7 = #{cnt7},</if>
			<if test="itemCd8 != ''">item_cd8 = #{itemCd8}, item_name8 = #{itemName8}, cnt8 = #{cnt8},</if>
			<if test="itemCd9 != ''">item_cd9 = #{itemCd9}, item_name9 = #{itemName9}, cnt9 = #{cnt9},</if>
			<if test="itemCd10 != ''">item_cd10 = #{itemCd10}, item_name10 = #{itemName10}, cnt10 = #{cnt10},</if>
			<if test="itemCd11 != ''">item_cd11 = #{itemCd11}, item_name11 = #{itemName11}, cnt11 = #{cnt11},</if>
			<if test="itemCd12 != ''">item_cd12 = #{itemCd12}, item_name12 = #{itemName12}, cnt12 = #{cnt12},</if>
			<if test="itemCd13 != ''">item_cd13 = #{itemCd13}, item_name13 = #{itemName13}, cnt13 = #{cnt13},</if>
			<if test="itemCd14 != ''">item_cd14 = #{itemCd14}, item_name14 = #{itemName14}, cnt14 = #{cnt14},</if>
			<if test="itemCd15 != ''">item_cd15 = #{itemCd15}, item_name15 = #{itemName15}, cnt15 = #{cnt15},</if>
			item_cd1 = #{itemCd1}, item_name1 = #{itemName1}, cnt1 = #{cnt1}
		WHERE wo_idx = #{woIdx}
	</update>
	
	<select id="selectExistsInMaterial" resultType="int">
		SELECT COUNT(*) FROM sm_in_material 
		WHERE wo_idx = (SELECT CONCAT(CONCAT('WO',SUBSTRING(DATE_FORMAT(#{woItnDte},'%Y%m'),3,6)),'',
							(SELECT LPAD((SELECT IFNULL(MAX(SUBSTRING(a.wo_idx,7,9)),0)
								FROM sm_work_order a 
								WHERE a.wo_idx 
								LIKE CONCAT(CONCAT('WO',SUBSTRING(DATE_FORMAT(#{woItnDte},'%Y%m'),3,6)), '%')),3,0))) AS WO)
	</select>
	
	<delete id="deleteInMaterial">
		DELETE FROM sm_in_material WHERE wo_idx = #{woIdx}
	</delete>
	
	<delete id="deleteProcess">
		DELETE FROM sm_process WHERE wo_idx = #{woIdx}
	</delete>
	
	<insert id="registInsertInfo">
		INSERT INTO sm_insert_info
			(
			wo_idx,
			in_dte,
			in_reg_dte,
			in_reg_mem
			)
		VALUES
			(
			(SELECT CONCAT(CONCAT('WO',SUBSTRING(DATE_FORMAT(#{woItnDte},'%Y%m'),3,6)),'',
				(SELECT LPAD((SELECT IFNULL(MAX(SUBSTRING(a.wo_idx,7,9)),0)
					FROM sm_work_order a 
					WHERE a.wo_idx 
					LIKE CONCAT(CONCAT('WO',SUBSTRING(DATE_FORMAT(#{woItnDte},'%Y%m'),3,6)), '%')),3,0))) AS WO),
			#{woItnDte},
			NOW(),
			#{userId}
			)
	</insert>
	
	<delete id="deleteInsertInfo">
		DELETE FROM sm_insert_info WHERE wo_idx = #{woIdx}
	</delete>
	
	<update id="updateMaterialStock">
		UPDATE sm_item SET
			item_cnt = (item_cnt + ${cnt})
		WHERE item_cd = #{itemCd}
	</update>
</mapper>