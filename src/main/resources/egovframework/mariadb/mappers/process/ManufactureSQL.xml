<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper
	namespace="apc.sl.process.manufacture.service.impl.ManufactureMapper">

	<select id="selectManufactureListToCnt" resultType="int">
		SELECT COUNT(*)
		FROM sm_mf_proc
		<if test="searchKeyword != ''">
			AND po_lotno LIKE CONCAT('%', #{searchKeyword}, '%')
		</if>
		<if test="searchStDate != ''">
			AND mp_reg_date >= #{searchStDate}
		</if>
		<if test="searchEdDate !=''">
			AND mp_reg_date <![CDATA[<=]]>
			#{searchEdDate}
		</if>

	</select>

	<select id="selectManufactureList" resultType="egovMap">
		select
		mp_idx, 
		mp_mfno,
		eq_id,
		po_lotno,
		pi_item_type,
		mp_mf_qty,
		mp_bad_qty
		from sm_mf_proc
		WHERE 1=1
		<if test="searchKeyword != ''">
			AND po_lotno LIKE CONCAT('%', #{searchKeyword}, '%')
		</if>
		<if test="searchStDate != ''">
			AND mp_reg_date >= #{searchStDate}
		</if>
		<if test="searchEdDate !=''">
			AND mp_reg_date <![CDATA[<=]]>
			#{searchEdDate}
		</if>

		ORDER BY mp_mfno DESC
		OFFSET #{firstIndex} ROWS
		FETCH NEXT #{recordCountPerPage} ROWS ONLY

	</select>


	<select id="selelctEQList" resultType="egovMap">
	SELECT eq_id,eq_name FROM
		sm_equipment
	</select>
	
	<select id="selectLotnoList" resultType="egovMap">
		SELECT po_lotno FROM
		sm_product_order
		where po_state IN (0,1)
	</select>
	
	<select id="selectExistsLot" resultType="int">
	SELECT COUNT(*)
		FROM
		sm_product_order WHERE po_lotno = #{poLotno}
	</select>

	<select id="selectInfo" resultType="egovMap">
		SELECT a.po_lotno,
		b.pi_item_type,a.po_order_qty , a.po_state FROM
		sm_product_order a JOIN
		sm_product_info b ON a.PI_ID=b.PI_ID
		WHERE a.po_lotno = #{poLotno}
	</select>
	
	<select id="selectMfInfo" resultType="egovMap">
	SELECT
		a.mp_idx,
		a.eq_id,
		a.po_lotno,
		a.pi_item_type,
		a.mp_mfno,
		a.mp_mf_qty,
		a.mp_bad_qty,
		b.eq_name,
		c.po_state,
		a.mp_starttime,
		a.mp_endtime
		FROM
		sm_mf_proc a
		join
		sm_equipment b on a.eq_id = b.eq_id
		JOIN sm_product_order c ON
		a.po_lotno = c.po_lotno
		WHERE 1=1
		AND mp_idx = #{mpIdx}
	</select>

	<select id="selctExistsEq" resultType="int">
		SELECT COUNT(*) FROM
		sm_equipment WHERE eq_id = #{eqId}
	</select>

	<select id="selectCheck" resultType="egovMap">
		SELECT a.ch_idx, a.in_idx,
		ch_state, ch_recycle, ch_reason, b.in_name
		FROM sm_insp_change a
		JOIN
		sm_incongruity b
		ON a.in_idx=b.in_idx
		WHERE a.ch_IDX = #{chIdx}
	</select>

	<select id="selectDetailManufacture" resultType="egovMap">
		SELECT in_name,
		ch_state, item_name, ti_name, wo_pdt_cnt, ch_recycle, ch_reason,
		DATE_FORMAT(ch_reg_dte, '%Y-%m-%d') AS ch_reg_dte
		FROM sm_insp_change a
		JOIN sm_incongruity b ON a.IN_IDX=b.IN_IDX
		JOIN sm_analysis_info c ON
		b.TI_IDX = c.TI_IDX
		JOIN sm_work_order d ON c.WO_IDX = d.WO_IDX
		JOIN
		sm_item e ON d.ITEM_CD = e.ITEM_CD
		WHERE a.CH_IDX = #{chIdx}
	</select>


	<insert id="registManufacture">
		insert into sm_mf_proc (
		mp_mfno,
		eq_id,
		po_lotno,
		pi_item_type,
		mp_starttime,
		mp_endtime,
		mp_mf_qty,
		mp_bad_qty,
		mp_reg_id,
		mp_reg_date
		) values(
		#{mpMfno},
		#{eqId},
		#{poLotno},
		#{piItemType},
		#{mpStarttime},
		#{mpEndtime},
		#{mpMfQty},
		#{mpBadQty},
		#{userId},
		GETDATE()
		)
	</insert>

	<update id="modifyManufacture">
		UPDATE sm_mf_proc
		SET eq_id = #{eqId},
		mp_mfno = #{mpMfno},
		mp_starttime = #{mpStarttime},
		mp_endtime = #{mpEndtime},
		mp_mf_qty = #{mpMfQty},
		mp_bad_qty = #{mpBadQty},
		mp_edt_date = GETDATE(),
		mp_edt_id = #{userId}
		WHERE mp_idx = #{mpIdx}
		
		UPDATE sm_product_order
		SET po_state = #{poState}
		WHERE po_lotno = (
    	SELECT po_lotno
    	FROM sm_mf_proc
    	WHERE mp_idx = #{mpIdx}
		)
	</update>

<!-- 	<delete id="deleteManufacture"> -->

<!-- 		Delete From sm_insp_change where ch_idx = #{chIdx} -->
<!-- 	</delete> -->

</mapper>