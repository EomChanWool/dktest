<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="apc.sl.process.cut.service.impl.CutMapper">
	<select id="selectCutListToCnt" resultType="int">
		SELECT COUNT(*) FROM sm_cut_proc
		WHERE 1=1
		<if test="searchKeyword != ''">
			AND po_lotno LIKE CONCAT('%',#{searchKeyword},'%')
		</if>
		<if test="searchStDate != ''">
			AND cp_Starttime >= #{searchStDate}
		</if>
		<if test="searchEdDate !=''">
			AND cp_Starttime <![CDATA[<=]]>
			#{searchEdDate}
		</if>
	</select>

	<select id="selectCutList" resultType="egovMap">
		SELECT
		a.cp_idx,
		a.eq_id,
		a.po_lotno,
		a.pi_item_type,
		a.cp_cutno,
		a.cp_cut_qty,
		a.cp_bad_qty,
		b.eq_name
		FROM
		sm_cut_proc a
		join sm_equipment
		b on a.eq_id = b.eq_id
		WHERE 1=1
		<if test="searchKeyword != ''">
			AND po_lotno LIKE CONCAT('%',#{searchKeyword},'%')
		</if>
		<if test="searchStDate != ''">
			AND cp_Starttime >= #{searchStDate}
		</if>
		<if test="searchEdDate !=''">
			AND cp_Starttime <![CDATA[<=]]>
			#{searchEdDate}
		</if>
		ORDER BY cp_cutno DESC
		OFFSET #{firstIndex} ROWS
		FETCH NEXT
		#{recordCountPerPage} ROWS ONLY
	</select>
	
	<select id="detailCut" resultType="egovMap">
	select * from sm_cut_proc where cp_idx = #{cpIdx}
	</select>


	<select id="selectEQList" resultType="egovMap">
		SELECT eq_id,eq_name FROM
		sm_equipment
	</select>

	<select id="selectLotnoList" resultType="egovMap">
		SELECT po_lotno FROM
		sm_product_order
		where po_state IN (0,1)
	</select>

	<select id="selectCutAjax" resultType="egovMap">
		SELECT a.po_lotno,
		b.pi_item_type,a.po_order_qty , a.po_state FROM
		sm_product_order a JOIN
		sm_product_info b ON a.PI_ID=b.PI_ID
		WHERE a.po_lotno = #{poLotno}
	</select>

	<update id="updatePoState">
		update sm_product_order set
		po_state = #{poState}
		where po_lotno = #{poLotno}
	</update>



	<select id="selctExistsEq" resultType="int">
		SELECT COUNT(*) FROM
		sm_equipment WHERE eq_id = #{eqId}
	</select>

	<select id="selectExistsLot" resultType="int">
		SELECT COUNT(*)
		FROM
		sm_product_order WHERE po_lotno = #{poLotno}
	</select>

	<select id="selectExistsProdResult" resultType="int">
		SELECT COUNT(*)
		FROM sm_prod_result WHERE wo_idx = #{woIdx} AND pr_list_nm = #{prNm}
	</select>

	<insert id="registCut">
		insert into sm_cut_proc (
		cp_cutno,
		eq_id,
		po_lotno,
		pi_item_type,
		cp_starttime,
		cp_endtime,
		cp_cut_qty,
		cp_bad_qty,
		cp_reg_id,
		cp_reg_date
		) values(
		#{cpCutno},
		#{eqId},
		#{poLotno},
		#{piItemType},
		#{cpStarttime},
		#{cpEndtime},
		#{cpCutQty},
		#{cpBadQty},
		#{userId},
		GETDATE()
		)
	</insert>

	<select id="selectCutInfo" resultType="egovMap">
		SELECT
		a.cp_idx,
		a.eq_id,
		a.po_lotno,
		a.pi_item_type,
		a.cp_cutno,
		a.cp_cut_qty,
		a.cp_bad_qty,
		b.eq_name,
		c.po_state,
		a.cp_starttime,
		a.cp_endtime
		FROM
		sm_cut_proc a
		join
		sm_equipment b on a.eq_id = b.eq_id
		JOIN sm_product_order c ON
		a.po_lotno = c.po_lotno
		WHERE 1=1
		AND cp_idx = #{cpIdx}
	</select>
	<!-- <update id="updateProcess2"> -->
	<!-- UPDATE sm_process SET -->
	<!-- pr_cur_seq = (pr_cur_seq - 1), -->
	<!-- pr_cur_idx = (SELECT -->
	<!-- ${nextIdx} FROM sm_process WHERE wo_idx = -->
	<!-- #{woIdx}), -->
	<!-- pr_cur_nm = -->
	<!-- (SELECT pr_list_nm3 FROM sm_process WHERE wo_idx -->
	<!-- = -->
	<!-- #{woIdx}), -->
	<!-- pr_fin_cnt -->
	<!-- = (pr_fin_cnt - 1) -->
	<!-- WHERE wo_idx = #{woIdx} -->
	<!-- </update> -->

	<!-- <update id="modifyAnalysisData"> -->
	<!-- UPDATE sm_anlz_data SET -->
	<!-- az_brix_std = #{azBrixStd}, -->
	<!-- az_brix = #{azBrix}, -->
	<!-- az_water_std = #{azWaterStd}, -->
	<!-- az_water = -->
	<!-- #{azWater}, -->
	<!-- az_ph_std = #{azPhStd}, -->
	<!-- az_ph = #{azPh}, -->
	<!-- az_temp_std = -->
	<!-- #{azTempStd}, -->
	<!-- az_temp = #{azTemp}, -->
	<!-- az_viscosity_std = #{azViscosityStd}, -->
	<!-- az_viscosity = #{azViscosity}, -->
	<!-- az_sg_std = #{azSgStd}, -->
	<!-- az_sg = #{azSg} -->
	<!-- WHERE az_idx = #{azIdx} -->
	<!-- </update> -->

	<update id="modifyCut">
		UPDATE sm_cut_proc
		SET eq_id = #{eqId},
		cp_cutno = #{cpCutno},
		cp_starttime = #{cpStarttime},
		cp_endtime = #{cpEndtime},
		cp_cut_qty = #{cpCutQty},
		cp_bad_qty = #{cpBadQty},
		cp_edt_date = GETDATE(),
		cp_edt_id = #{userId}
		WHERE cp_idx = #{cpIdx}
		
		UPDATE sm_product_order
		SET po_state = #{poState}
		WHERE po_lotno = (
    	SELECT po_lotno
    	FROM sm_cut_proc
    	WHERE cp_idx = #{cpIdx}
		)

	</update>

	<!-- <update id="updatePrReReSt"> -->
	<!-- UPDATE sm_prod_result a JOIN sm_work_order b ON -->
	<!-- a.WO_IDX=b.WO_IDX -->
	<!-- JOIN sm_analysis_info c ON b.WO_IDX=c.WO_IDX -->
	<!-- SET -->
	<!-- a.PR_RE_RE_ST = 'Y' -->
	<!-- WHERE a.WO_IDX = #{woIdx} -->
	<!-- AND a.pr_re_idx = ( -->
	<!-- SELECT -->
	<!-- MAX(pr_re_idx) -->
	<!-- FROM sm_prod_result -->
	<!-- WHERE WO_IDX = #{woIdx} -->
	<!-- ) -->

	<!-- </update> -->

	<delete id="deleteCut">
	DELETE FROM sm_cut_proc WHERE cp_idx = #{cpIdx}
	</delete>
	<!-- <delete id="deleteProdResult"> -->
	<!-- DELETE FROM sm_prod_result WHERE wo_idx = #{woIdx} -->
	<!-- AND PR_LIST_NM = '품질검사' -->
	<!-- </delete> -->

	<select id="selectOrderState" resultType="egovMap">
		SELECT b.or_state FROM
		sm_work_order a JOIN
		sm_orders b ON a.OR_IDX=b.OR_IDX
		WHERE a.wo_idx =
		#{woIdx}
	</select>

	<select id="selectAnalysisCnt" resultType="egovMap">
		SELECT
		COUNT(*) AS
		total,
		(SELECT COUNT(*) FROM sm_prod_result WHERE pr_list_nm = '품질검사')
		AS
		analysisCnt,
		(SELECT COUNT(*) FROM sm_process WHERE pr_cur_nm='품질검사')
		AS processingCnt
		FROM sm_work_order
	</select>

	<!-- <update id="updateDocumnetState"> -->
	<!-- UPDATE sm_document SET -->
	<!-- do_state = #{state} -->
	<!-- WHERE do_idx -->
	<!-- = #{doIdx} -->
	<!-- </update> -->
</mapper>