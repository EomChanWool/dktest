<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper
	namespace="apc.sl.process.performance.service.impl.PerformanceMapper">
	<select id="selectPerformanceListToCnt" resultType="int">
		SELECT COUNT(*) FROM sm_perf_test
		WHERE 1=1
		<if test="searchKeyword">
			AND or_id = #{searchKeyword}
		</if>
		<if test="searchStDate != ''">
			AND pt_starttime >= #{searchStDate}
		</if>
		<if test="searchEdDate !=''">
			AND pt_starttime <![CDATA[<=]]>
			#{searchEdDate}
		</if>
	</select>

	<select id="selectPerformanceList" resultType="egovMap">
		SELECT
		pt_perfno,
		a.eq_id,
		b.EQ_NAME,
		or_id,
		pt_mf_qty,
		pt_bad_qty
		FROM
		sm_perf_test a
		JOIN sm_equipment b
		ON a.EQ_ID = b.EQ_ID
		WHERE 1=1
		<if test="searchKeyword !=''">
			AND or_id = #{searchKeyword}
		</if>
		<if test="searchStDate != ''">
			AND pt_starttime >= #{searchStDate}
		</if>
		<if test="searchEdDate !=''">
			AND pt_starttime <![CDATA[<=]]>
			#{searchEdDate}
		</if>
		ORDER BY pt_perfno DESC
		OFFSET #{firstIndex} ROWS
		FETCH NEXT
		#{recordCountPerPage} ROWS ONLY
	</select>

	<!-- <insert id="registDocument"> -->
	<!-- INSERT INTO sm_document -->
	<!-- ( -->
	<!-- do_idx, -->
	<!-- do_type, -->
	<!-- do_name, -->
	<!-- do_manager, -->
	<!-- do_dte, -->
	<!-- do_origin_fil_nm, -->
	<!-- do_fil_nm, -->
	<!-- <if test="doNote">do_note,</if> -->
	<!-- do_reg_dte, -->
	<!-- do_reg_mem -->
	<!-- ) -->
	<!-- VALUES -->
	<!-- ( -->
	<!-- (SELECT CONCAT(CONCAT('DO',SUBSTRING(DATE_FORMAT(#{doDte},'%Y%m%d'),3,6)),'-', -->
	<!-- (SELECT LPAD((SELECT IFNULL(MAX(SUBSTRING(a.do_idx,10,12)),0)+1 -->
	<!-- FROM sm_document a -->
	<!-- WHERE a.do_idx -->
	<!-- LIKE CONCAT(CONCAT('DO',SUBSTRING(DATE_FORMAT(#{doDte},'%Y%m%d'),3,8)), 
		'%')),3,0))) AS DO), -->
	<!-- #{type}, -->
	<!-- #{doName}, -->
	<!-- #{doManager}, -->
	<!-- #{doDte}, -->
	<!-- #{doOriginFilNm}, -->
	<!-- #{doFilNm}, -->
	<!-- <if test="doNote">#{doNote},</if> -->
	<!-- NOW(), -->
	<!-- #{userId} -->
	<!-- ) -->
	<!-- </insert> -->

	<insert id="registcheckPr">
		INSERT INTO sm_perf_test(
		eq_id,
		or_id,
		pt_starttime,
		pt_endtime,
		pt_mf_qty,
		pt_bad_qty,
		pt_reg_id,
		pt_reg_date
		) VALUES (
		#{eqId},
		#{orId},
		#{ptStarttime},
		#{ptEndtime},
		#{ptMfQty},
		#{ptBadQty},
		#{userId},
		GETDATE()
		)


	</insert>

	<select id="selectFmList" resultType="egovMap">
		SELECT *
		FROM sm_equipment
		where eq_type = '가공'
	</select>

	<select id="selectOrderList" resultType="egovMap">
		SELECT a.or_id
		FROM sm_mf_proc_log a
		WHERE MFL_ED_DATE IS NOT NULL
		AND NOT EXISTS (
		SELECT 1
		FROM sm_perf_test
		WHERE or_id = a.or_id
		)
	</select>

	<select id="performanceInfo" resultType="egovMap">
		SELECT convert(CHAR(19),
		a.mfl_st_date,20) AS mfl_st_date, convert(CHAR(19),a.mfl_ed_date,20)
		AS
		mfl_ed_date, b.or_qty
		FROM sm_mf_proc_log a JOIN
		sm_orders b ON
		a.OR_ID = b.OR_ID
		WHERE a.or_id = #{orId}
	</select>

	<select id="checkOrid" resultType="int">
		SELECT COUNT(*) FROM
		sm_mf_proc_log WHERE or_id = #{orId}
	</select>

	<select id="selectCheckPrInfo" resultType="egovMap">
		SELECT * FROM
		sm_perf_test
		WHERE pt_perfno = #{ptPerfno}
	</select>
	
	<update id="modifyCheckPr">
	update sm_perf_test set
	pt_bad_qty = #{ptBadQty},
	pt_edt_id = #{userId},
	pt_edt_date = GETDATE()
	where pt_perfno = #{ptPerfno}
	</update>

	<!-- <update id="modifyDocument"> -->
	<!-- UPDATE sm_document SET -->
	<!-- do_name = #{doName}, -->
	<!-- <if test="doFilNm != ''"> -->
	<!-- do_origin_fil_nm = #{orginFileName}, -->
	<!-- do_fil_nm = #{doFilNm}, -->
	<!-- </if> -->
	<!-- do_manager = #{doManager}, -->
	<!-- <if test="doNote != ''">do_note = #{doNote},</if><if test="doNote == 
		''">do_note = null,</if> -->
	<!-- do_edt_dte = NOW(), -->
	<!-- do_edt_mem = #{userId} -->
	<!-- WHERE do_idx = #{doIdx} -->
	<!-- </update> -->

	<!-- <delete id="deletePerformance"> -->
	<!-- DELETE FROM sm_document WHERE do_idx = #{doIdx} -->
	<!-- </delete> -->
</mapper>